name: Dependency Update

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}

jobs:
  upgrade-dependencies:
    runs-on: ubuntu-latest
    env:
      deps_branch_name: dep-update
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # We deliberately do not use the setup action, as we do not want node caching here.
      - name: Configure direnv
        uses: HatsuneMiku3939/direnv-action@v1

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Upgrade all node dependencies
        id: upgrade
        shell: bash
        run: |
          yarn install:all
          yarn workspaces run upgrade-interactive --latest
          if [ "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit code to deps branch
        if: ${{ steps.upgrade.outputs.changes }}
        shell: bash
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git branch -D $deps_branch_name || true
          git checkout -b $deps_branch_name
          git commit -a -m "chore(deps): Upgrade all node dependencies"
          git push --set-upstream origin $deps_branch_name --force

      - name: Slack Notification - notify of failure
        uses: rtCamp/action-slack-notify@v2.2.0
        if: env.SLACK_WEBHOOK != '' && failure()
        env:
          SLACK_COLOR: ${{job.status}}
          SLACK_ICON: https://github.com/${{ github.repository_owner }}.png?size=48
          SLACK_TITLE: Failure
          SLACK_USERNAME: ${{ github.repository }} ${{job.status}}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

      - name: Slack Notification - notify of success
        uses: rtCamp/action-slack-notify@v2.2.0
        if: env.SLACK_WEBHOOK != ''
        env:
          SLACK_COLOR: ${{job.status}}
          SLACK_ICON: https://github.com/${{ github.repository_owner }}.png?size=48
          SLACK_TITLE: Update Dependencies Workflow - SUCCESS
          SLACK_MESSAGE: Click https://github.com/${{ github.repository }}/compare/master...${{ env.deps_branch_name }}?quick_pull=1&labels=deps&title=chore(deps):+Update+Dependencies&body=Update+all+dependencies. to create a PR for the updates to go to master.
          SLACK_USERNAME: ${{ github.repository }} ${{job.status}}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
