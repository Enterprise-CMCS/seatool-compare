name: List Running Stages

on:
  workflow_dispatch:
  schedule:
    # Run daily at 9 AM UTC (adjust as needed)
    - cron: '0 9 * * *'

jobs:
  list-running-stages:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      PROJECT: compare
      REGION_A: us-east-1
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: List running stages
        id: list-stages
        run: node scripts/list-running-stages.cjs

      - name: Github Issue
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const stages = '${{ steps.list-stages.outputs.stages }}';
            const body = stages ? 
              `ðŸš€ **Running Stages in ${process.env.REGION_A}:**\n\n${stages.split(',').map(s => `- \`${s}\``).join('\n')}` :
              `âœ… **No running stages found in ${process.env.REGION_A}**`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Slack notification
        if: env.SLACK_WEBHOOK != ''
        uses: rtCamp/action-slack-notify@v2.2.0
        env:
          SLACK_COLOR: good
          SLACK_ICON: https://github.com/Enterprise-CMCS.png?size=48
          SLACK_TITLE: Running Stages Report
          SLACK_MESSAGE: |
            Region: ${{ env.REGION_A }}
            Running Stages: ${{ steps.list-stages.outputs.stages || 'None' }}
          SLACK_USERNAME: ${{ github.repository }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }} 