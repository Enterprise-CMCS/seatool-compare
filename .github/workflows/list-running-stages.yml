name: List Running Stages

on:
  workflow_dispatch:
  schedule:
    # Run daily at 9 AM UTC (adjust as needed)
    - cron: '0 9 * * *'

jobs:
  list-running-stages:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      PROJECT: compare
      REGION_A: us-east-1
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: List running stages
        run: |
          node -e "
          const { ServerlessRunningStages } = require('@enterprise-cmcs/macpro-serverless-running-stages');
          
          async function listStages() {
            try {
              const region = process.env.REGION_A;
              console.log(\`Checking running stages in region: \${region}\`);
              
              const runningStages = await ServerlessRunningStages.getAllStagesForRegion(region);
              console.log(\`runningStages=\${runningStages.join(',')}\`);
              
              if (runningStages.length === 0) {
                console.log('No running stages found');
              } else {
                console.log(\`Found \${runningStages.length} running stages:\`);
                runningStages.forEach(stage => console.log(\`  - \${stage}\`));
              }
            } catch (error) {
              console.error('Error listing running stages:', error);
              process.exit(1);
            }
          }
          
          listStages();
          "

      - name: Set output
        id: stages
        run: |
          STAGES=$(node -e "
          var { ServerlessRunningStages } = require('@enterprise-cmcs/macpro-serverless-running-stages');
          
          async function getStages() {
            try {
              var runningStages =  ServerlessRunningStages.getAllStagesForRegion(process.env.REGION_A).then(stages => stages.join(','));
              console.log(runningStages);
            } catch (error) {
              console.error('Error:', error);
              process.exit(1);
            }
          }
          
          getStages();
          ")
          echo "stages=$STAGES" >> $GITHUB_OUTPUT

      - name: Github Issue
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const stages = '${{ steps.stages.outputs.stages }}';
            const body = stages ? 
              `ðŸš€ **Running Stages in ${process.env.REGION_A}:**\n\n${stages.split(',').map(s => `- \`${s}\``).join('\n')}` :
              `âœ… **No running stages found in ${process.env.REGION_A}**`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Slack notification
        if: env.SLACK_WEBHOOK != ''
        uses: rtCamp/action-slack-notify@v2.2.0
        env:
          SLACK_COLOR: good
          SLACK_ICON: https://github.com/Enterprise-CMCS.png?size=48
          SLACK_TITLE: Running Stages Report
          SLACK_MESSAGE: |
            Region: ${{ env.REGION_A }}
            Running Stages: ${{ steps.stages.outputs.stages || 'None' }}
          SLACK_USERNAME: ${{ github.repository }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }} 