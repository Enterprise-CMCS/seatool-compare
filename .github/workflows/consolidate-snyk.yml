name: Consolidate Snyk PRs

on:
  schedule:
    - cron: '0 0 * * *' # every night at midnight UTC
  workflow_dispatch:

jobs:
  consolidate-snyk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all open Snyk PR branches
        id: snyk_prs
        run: |
          SNYK_BRANCHES=$(gh pr list --state open --json headRefName,title --jq '.[] | select(.title | test("\\[Snyk\\]")) | .headRefName' | xargs)
          echo "branches=$SNYK_BRANCHES" >> $GITHUB_OUTPUT

      - name: Create and merge Snyk branches
        id: merge
        run: |
          DATE=$(date %m%d)
          NEW_BRANCH="snyk-merge-$DATE"
          git checkout master
          git pull origin master
          git checkout -b "$NEW_BRANCH"
          MERGED_BRANCHES=()
          for BRANCH in ${{ steps.snyk_prs.outputs.branches }}; do
            echo "Merging $BRANCH..."
            git fetch origin "$BRANCH"
            if git merge --no-ff --no-edit "origin/$BRANCH"; then
              MERGED_BRANCHES+=("$BRANCH")
            else
              echo "Merge conflict with $BRANCH! Aborting."
              exit 1
            fi
          done
          git push origin "$NEW_BRANCH"
          echo "merged_branches=${MERGED_BRANCHES[*]}" >> $GITHUB_OUTPUT
          echo "new_branch=$NEW_BRANCH" >> $GITHUB_OUTPUT

      - name: Create PR for consolidated Snyk updates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="This PR consolidates the following Snyk security update branches:\n"
          for BRANCH in ${{ steps.merge.outputs.merged_branches }}; do
            BODY+="* $BRANCH\n"
          done
          BODY+="\nMerged automatically for easier review and deployment."
          gh pr create \
            --base master \
            --head "${{ steps.merge.outputs.new_branch }}" \
            --title "chore(deps): update snyk package updates" \
            --body "$BODY" \
            --label "dependencies" 