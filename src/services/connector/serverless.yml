service: ${self:custom.project}-connector

frameworkVersion: "3"

package:
  individually: true

plugins:
  - serverless-esbuild
  - serverless-stack-termination-protection
  - "@stratiformdigital/serverless-iam-helper"
  - "@stratiformdigital/serverless-online"
  - "@stratiformdigital/serverless-s3-security-helper"

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:REGION_A}
  stackTags:
    PROJECT: ${self:custom.project}
    SERVICE: ${self:service}
  iam:
    role:
      path: /delegatedadmin/developer/
      permissionsBoundary: arn:aws:iam::${aws:accountId}:policy/cms-cloud-admin/developer-boundary-policy
      statements:
        # VPC permissions for Lambda to connect to MSK
        - Effect: "Allow"
          Action:
            - ec2:CreateNetworkInterface
            - ec2:DeleteNetworkInterface
            - ec2:DescribeNetworkInterfaces
            - ec2:DescribeSecurityGroups
            - ec2:DescribeSubnets
            - ec2:DescribeVpcs
          Resource: "*"
        # DynamoDB permissions
        - Effect: "Allow"
          Action:
            - dynamodb:PutItem
            - dynamodb:DeleteItem
          Resource:
            - ${param:seatoolTableArn}
            - ${param:appianTableArn}
        # MSK permissions for event source mapping
        - Effect: "Allow"
          Action:
            - kafka:DescribeCluster
            - kafka:DescribeClusterV2
            - kafka:GetBootstrapBrokers
            - kafka-cluster:Connect
            - kafka-cluster:DescribeGroup
            - kafka-cluster:AlterGroup
            - kafka-cluster:DescribeTopic
            - kafka-cluster:ReadData
            - kafka-cluster:DescribeClusterDynamicConfiguration
          Resource:
            - ${self:custom.mskClusterArn}
            - !Sub "${self:custom.mskClusterArn}/*"
        # CloudWatch for metrics
        - Effect: "Allow"
          Action:
            - cloudwatch:PutMetricData
          Resource: "*"

custom:
  project: ${env:PROJECT}
  esbuild:
    bundle: true
    minify: false
    sourcemap: false
    exclude:
      - "@aws-sdk/*"
    target: "node20"
    platform: "node"
    concurrency: 10
    keepNames: true
  serverlessTerminationProtection:
    stages:
      - master
      - val
      - production
  vpc: ${ssm:/aws/reference/secretsmanager/${self:custom.project}/${sls:stage}/vpc, ssm:/aws/reference/secretsmanager/${self:custom.project}/default/vpc}
  # MSK configuration - all values from Secrets Manager (no hardcoded fallbacks)
  mskClusterArn: ${ssm:/aws/reference/secretsmanager/${self:custom.project}/${sls:stage}/mskClusterArn, ssm:/aws/reference/secretsmanager/${self:custom.project}/default/mskClusterArn}
  # Bootstrap brokers and Kafka subnets loaded via CloudFormation Parameters from SSM StringList (see resources.Parameters)

params:
  master:
    topicNamespace: ""
  val:
    topicNamespace: ""
  production:
    topicNamespace: ""
  default:
    topicNamespace: --${self:custom.project}--${sls:stage}--

functions:
  sinkAppianData:
    handler: handlers/sinkAppianData.handler
    timeout: 60
    memorySize: 512
    environment:
      tableName: ${param:appianTableName}
      stage: ${sls:stage}
      region: ${self:provider.region}
    vpc:
      securityGroupIds:
        - !Ref LambdaKafkaSecurityGroup
      subnetIds: >-
        ${self:custom.vpc.privateSubnets}
    # MSK event source managed via CloudFormation resources with Provisioned Mode

  sinkSeatoolData:
    handler: handlers/sinkSeatoolData.handler
    timeout: 60
    memorySize: 512
    environment:
      tableName: ${param:seatoolTableName}
      stage: ${sls:stage}
      region: ${self:provider.region}
    vpc:
      securityGroupIds:
        - !Ref LambdaKafkaSecurityGroup
      subnetIds: >-
        ${self:custom.vpc.privateSubnets}
    # MSK event source managed via CloudFormation resources with Provisioned Mode

resources:
  Parameters:
    # SSM StringList parameter for bootstrap brokers - resolves to array at deploy time
    BootstrapBrokersParam:
      Type: "AWS::SSM::Parameter::Value<List<String>>"
      Default: "/compare/default/bootstrapBrokers"
    # SSM StringList parameter for Kafka subnets - resolves to array at deploy time
    KafkaSubnetsParam:
      Type: "AWS::SSM::Parameter::Value<List<String>>"
      Default: "/compare/default/kafkaSubnets"

  Resources:
    # Security group for Lambda functions connecting to MSK
    LambdaKafkaSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security Group for Lambda functions connecting to MSK
        VpcId: ${self:custom.vpc.id}
        Tags:
          - Key: Name
            Value: ${self:service}-${sls:stage}-lambda-kafka-sg

    LambdaKafkaSecurityGroupEgress:
      Type: AWS::EC2::SecurityGroupEgress
      Properties:
        GroupId: !Ref LambdaKafkaSecurityGroup
        IpProtocol: -1
        CidrIp: 0.0.0.0/0

    # CloudWatch Alarms for Lambda errors
    AppianSinkErrorAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${sls:stage}-sinkAppianData-errors
        AlarmDescription: Errors in Appian sink Lambda
        AlarmActions:
          - ${param:alarmsTopicArn}
        ComparisonOperator: GreaterThanThreshold
        EvaluationPeriods: 1
        MetricName: Errors
        Namespace: AWS/Lambda
        Period: 300
        Statistic: Sum
        Threshold: 0
        Dimensions:
          - Name: FunctionName
            Value: !Ref SinkAppianDataLambdaFunction

    SeatoolSinkErrorAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${sls:stage}-sinkSeatoolData-errors
        AlarmDescription: Errors in Seatool sink Lambda
        AlarmActions:
          - ${param:alarmsTopicArn}
        ComparisonOperator: GreaterThanThreshold
        EvaluationPeriods: 1
        MetricName: Errors
        Namespace: AWS/Lambda
        Period: 300
        Statistic: Sum
        Threshold: 0
        Dimensions:
          - Name: FunctionName
            Value: !Ref SinkSeatoolDataLambdaFunction

    # Self-Managed Kafka Event Source Mapping for Appian Data
    # Uses bootstrap broker strings instead of MSK cluster ARN (proven working pattern from onemac-dev)
    AppianKafkaEventSourceMapping:
      Type: AWS::Lambda::EventSourceMapping
      Properties:
        FunctionName: !GetAtt SinkAppianDataLambdaFunction.Arn
        SelfManagedEventSource:
          Endpoints:
            KafkaBootstrapServers: !Ref BootstrapBrokersParam
        SourceAccessConfigurations:
          - Type: VPC_SUBNET
            URI: !Select [0, !Ref KafkaSubnetsParam]
          - Type: VPC_SUBNET
            URI: !Select [1, !Ref KafkaSubnetsParam]
          - Type: VPC_SUBNET
            URI: !Select [2, !Ref KafkaSubnetsParam]
          - Type: VPC_SECURITY_GROUP
            URI: !Sub "security_group:${LambdaKafkaSecurityGroup}"
        Topics:
          - aws.appian.cmcs.MCP_SPA_PCKG
        BatchSize: 100
        MaximumBatchingWindowInSeconds: 5
        StartingPosition: LATEST
        Enabled: true
        SelfManagedKafkaEventSourceConfig:
          ConsumerGroupId: ${param:topicNamespace}esm.${self:service}-${sls:stage}

    # Self-Managed Kafka Event Source Mapping for Seatool Data
    # Uses bootstrap broker strings instead of MSK cluster ARN (proven working pattern from onemac-dev)
    SeatoolKafkaEventSourceMapping:
      Type: AWS::Lambda::EventSourceMapping
      Properties:
        FunctionName: !GetAtt SinkSeatoolDataLambdaFunction.Arn
        SelfManagedEventSource:
          Endpoints:
            KafkaBootstrapServers: !Ref BootstrapBrokersParam
        SourceAccessConfigurations:
          - Type: VPC_SUBNET
            URI: !Select [0, !Ref KafkaSubnetsParam]
          - Type: VPC_SUBNET
            URI: !Select [1, !Ref KafkaSubnetsParam]
          - Type: VPC_SUBNET
            URI: !Select [2, !Ref KafkaSubnetsParam]
          - Type: VPC_SECURITY_GROUP
            URI: !Sub "security_group:${LambdaKafkaSecurityGroup}"
        Topics:
          - aws.ksqldb.seatool.agg.State_Plan
        BatchSize: 100
        MaximumBatchingWindowInSeconds: 5
        StartingPosition: LATEST
        Enabled: true
        SelfManagedKafkaEventSourceConfig:
          ConsumerGroupId: ${param:topicNamespace}esm.${self:service}-${sls:stage}

  Outputs:
    LambdaKafkaSecurityGroupId:
      Description: Security group ID for Lambda MSK connectivity
      Value: !Ref LambdaKafkaSecurityGroup
